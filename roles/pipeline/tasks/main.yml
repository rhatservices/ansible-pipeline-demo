---
- name: Install the OpenShift Pipelines operator
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: operators.coreos.com/v1alpha1
      kind: Subscription
      metadata:
        name: openshift-pipelines-operator-rh
        namespace: openshift-operators
      spec:
        channel: pipelines-1.7
        installPlanApproval: Automatic
        name: openshift-pipelines-operator-rh
        source: redhat-operators
        sourceNamespace: openshift-marketplace

- name: Create a namespace for the ansible-pipeline
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: ansible-pipeline

- name: Import git-clone task
  kubernetes.core.k8s:
    state: present
    src: git-clone.yaml
    namespace: ansible-pipeline

- name: Create secret for accessing Ansible Controller API
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: automation-controller-token
        namespace: ansible-pipeline
      data:
        token: "{{ controller_token | b64encode }}"
